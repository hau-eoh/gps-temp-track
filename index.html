<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS History - Debug & Fix</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; }

        /* MENU & UI */
        .control-panel { position: absolute; top: 10px; left: 50px; z-index: 1000; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 8px; font-size: 13px; min-width: 160px; }
        .control-label { font-weight: bold; color: #1890ff; font-size: 11px; text-transform: uppercase; }
        select, input[type="date"] { padding: 6px; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        .loading-bar { height: 3px; width: 0%; background: #1890ff; transition: width 0.3s; margin-top: 5px; border-radius: 2px; }
        
        /* INFO BOX */
        .info-box { position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 12px 15px; background: rgba(255, 255, 255, 0.98); box-shadow: 0 4px 20px rgba(0,0,0,0.2); border-radius: 10px; min-width: 180px; border: 1px solid #f0f0f0; }
        .info-title { font-weight: 800; color: #333; margin-bottom: 8px; border-bottom: 2px solid #1890ff; padding-bottom: 5px; text-align: center; font-size: 12px; }
        .info-item { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; color: #555; }
        .info-value { font-weight: bold; font-family: monospace; font-size: 14px; color: #222; }

        /* MARKER & POPUP */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin { filter: drop-shadow(0px 3px 6px rgba(0,0,0,0.4)); }
    </style>
</head>
<body>

<div class="control-panel">
    <label class="control-label">‚ö° Xem nhanh</label>
    <select id="quickSelect" onchange="loadQuickHistory()">
        <option value="" disabled selected>-- Ch·ªçn --</option>
        <option value="1">1 Gi·ªù qua</option>
        <option value="6">6 Gi·ªù qua</option>
        <option value="12">12 Gi·ªù qua</option>
        <option value="24">24 Gi·ªù qua</option>
    </select>
    <div style="text-align:center; color:#ccc; font-size:10px; margin: 5px 0;">‚Äî HO·∫∂C ‚Äî</div>
    <label class="control-label">üìÖ Ch·ªçn ng√†y</label>
    <input type="date" id="datePicker" onchange="loadDateHistory()">
    <div class="loading-bar" id="loader"></div>
    <div id="statusText" style="font-size:10px; color:#666; text-align:center; margin-top:5px; border-top:1px solid #eee; padding-top:5px;">S·∫µn s√†ng</div>
</div>

<div id="map"></div>

<script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>

<script>
    const eraWidget = new EraWidget();
    let configJSON;
    let LAT=0, LON=0, SPEED=0, ALT=0, TEMP=0, SATS=0;
    
    let map, marker, infoControl;
    let historyPolyline = null;
    let historyLayerGroup = null;

    const carPath = "M880 348H730l-10.4-38.6c-4.9-18.1-21.5-30.7-40.2-30.7H344.6c-18.7 0-35.3 12.5-40.2 30.7L294 348H144c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V380c0-17.7-14.3-32-32-32zM363.6 348l13-48h270.8l13 48H363.6zM848 732H176V412h672v320zM304 528c0-35.3 28.7-64 64-64s64 28.7 64 64-28.7 64-64 64-64-28.7-64-64z m352 0c0-35.3 28.7-64 64-64s64 28.7 64 64-28.7 64-64 64-64-28.7-64-64z";

    // --- 1. INIT ---
    eraWidget.init({
        onConfiguration: (configs) => {
            configJSON = configs.realtime_configs[0];
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
            // Load th·ª≠ 1h ƒë·∫ßu
            loadQuickHistory(1);
        },
        onValues: (values) => {
            if (configJSON && values[configJSON.id]) parseRealtime(values[configJSON.id].value);
        },
        onHistories: (history) => {
            setLoading(false);
            if (history && history[0] && history[0].data) {
                // Nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu th√¥ -> Chuy·ªÉn sang x·ª≠ l√Ω
                processHistory(history[0].data);
            } else {
                document.getElementById('statusText').innerText = "Kh√¥ng c√≥ d·ªØ li·ªáu log";
                clearMapHistory();
            }
        }
    });

    // --- 2. DATA REQUEST ---
    function loadQuickHistory(hoursOverride) {
        let hours = hoursOverride || document.getElementById('quickSelect').value;
        if (!hours) return;
        setLoading(true);
        const endTime = Date.now();
        const startTime = endTime - (hours * 60 * 60 * 1000);
        requestData(startTime, endTime);
    }

    function loadDateHistory() {
        const dateVal = document.getElementById('datePicker').value;
        if (!dateVal) return;
        document.getElementById('quickSelect').value = ""; 
        setLoading(true);
        const start = new Date(dateVal + "T00:00:00");
        const end = new Date(dateVal + "T23:59:59");
        requestData(start.getTime(), end.getTime());
    }

    function requestData(start, end) {
        clearMapHistory();
        eraWidget.requestHistories(start, end);
    }

    function clearMapHistory() {
        if (historyPolyline) { map.removeLayer(historyPolyline); historyPolyline = null; }
        if (historyLayerGroup) { historyLayerGroup.clearLayers(); }
    }

    function setLoading(isLoading) {
        document.getElementById('loader').style.width = isLoading ? '100%' : '0%';
        if(isLoading) document.getElementById('statusText').innerText = "ƒêang t·∫£i...";
    }

    // --- 3. X·ª¨ L√ù L·ªäCH S·ª¨ (LOGIC PARSER M·ªöI) ---
    
    // H√†m Parser ƒëa nƒÉng: C·ªë g·∫Øng l·∫•y JSON Object t·ª´ b·∫•t k·ª≥ input n√†o
    function safeJsonParse(input) {
        if (!input) return null;
        
        // N·∫øu ƒë√£ l√† object th√¨ tr·∫£ v·ªÅ lu√¥n
        if (typeof input === 'object') return input;

        // N·∫øu l√† string, c·ªë g·∫Øng parse
        if (typeof input === 'string') {
            const trimmed = input.trim();
            try {
                const parsed = JSON.parse(trimmed);
                
                // ƒê·ªá quy: N·∫øu parse xong v·∫´n ra string (Double stringify), parse ti·∫øp
                if (typeof parsed === 'string') {
                    return safeJsonParse(parsed);
                }
                return parsed;
            } catch (e) {
                return null;
            }
        }
        return null;
    }

    function processHistory(dataArray) {
        const latLngs = [];
        const cleanData = [];
        let skippedCount = 0;
        let validCount = 0;

        // DEBUG: In ra c·∫•u tr√∫c c·ªßa ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n ƒë·ªÉ ki·ªÉm tra
        if (dataArray.length > 0) {
            console.log("DEBUG RAW ITEM[0]:", dataArray[0]);
        }

        dataArray.forEach((item) => {
            // item[0]: Timestamp
            // item[1]: Value (c√≥ th·ªÉ l√† String, Object, ho·∫∑c l·ªìng nhau)
            
            let rawValue = item[1];
            
            // B∆∞·ªõc 1: D√πng h√†m parse ƒëa nƒÉng ƒë·ªÉ l·∫•y Object
            let d = safeJsonParse(rawValue);

            // B∆∞·ªõc 2: Ki·ªÉm tra d·ªØ li·ªáu sau parse
            if (d && d.lat !== undefined && d.lon !== undefined) {
                const lat = parseFloat(d.lat);
                const lon = parseFloat(d.lon);

                // B∆∞·ªõc 3: L·ªçc to·∫° ƒë·ªô
                if (!isNaN(lat) && !isNaN(lon) && Math.abs(lat) > 0.1 && Math.abs(lon) > 0.1) {
                    
                    latLngs.push([lat, lon]);
                    
                    cleanData.push({
                        lat: lat, lon: lon,
                        temp: parseFloat(d.temp || 0),
                        spd: parseFloat(d.spd || 0),
                        alt: parseFloat(d.alt || 0),
                        ts: item[0] // timestamp t·ª´ m·∫£ng g·ªëc
                    });
                    validCount++;
                } else {
                    skippedCount++;
                }
            } else {
                // N·∫øu parse th·∫•t b·∫°i ho·∫∑c kh√¥ng c√≥ field lat/lon
                skippedCount++;
            }
        });

        console.log(`K·∫øt qu·∫£ l·ªçc: H·ª£p l·ªá ${validCount}, B·ªè qua ${skippedCount}`);

        if (validCount > 0) {
            document.getElementById('statusText').innerText = `Hi·ªÉn th·ªã ${validCount} ƒëi·ªÉm\n(·∫®n ${skippedCount} ƒëi·ªÉm l·ªói)`;

            // V·∫Ω ƒë∆∞·ªùng n·ªëi
            historyPolyline = L.polyline(latLngs, {
                color: '#999', weight: 3, opacity: 0.5, dashArray: '5, 5'
            }).addTo(map);

            // V·∫Ω c√°c ch·∫•m Point
            historyLayerGroup = L.layerGroup().addTo(map);

            cleanData.forEach(pt => {
                const color = getGradientColor(pt.spd);
                const circle = L.circleMarker([pt.lat, pt.lon], {
                    radius: 5, fillColor: color, color: '#fff', weight: 1, opacity: 1, fillOpacity: 1
                });
                
                const timeStr = new Date(pt.ts).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                const popupContent = `
                    <div style="text-align:center">
                        <div style="font-size:10px; color:#888">${timeStr}</div>
                        <div style="font-size:18px; font-weight:bold; color:${color}">${pt.spd.toFixed(0)} km/h</div>
                        <div style="font-size:12px; margin-top:2px;">Temp: <b style="color:#ff4d4f">${pt.temp}¬∞C</b></div>
                    </div>
                `;
                circle.bindPopup(popupContent, { closeButton: false });
                circle.addTo(historyLayerGroup);
            });

            // Zoom b·∫£n ƒë·ªì
            map.fitBounds(historyPolyline.getBounds(), { padding: [50, 50] });

            // Marker Start/End
            L.marker(latLngs[0], { title: 'B·∫Øt ƒë·∫ßu' }).addTo(historyLayerGroup).bindPopup("<b>B·∫Øt ƒë·∫ßu</b>");
            L.marker(latLngs[latLngs.length-1], { title: 'K·∫øt th√∫c' }).addTo(historyLayerGroup).bindPopup("<b>K·∫øt th√∫c</b>");

        } else {
            // C√≥ d·ªØ li·ªáu t·∫£i v·ªÅ nh∆∞ng kh√¥ng parse ƒë∆∞·ª£c ƒëi·ªÉm n√†o h·ª£p l·ªá
            console.log("D·ªØ li·ªáu t·∫£i v·ªÅ:", dataArray);
            document.getElementById('statusText').innerText = "D·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON";
            alert("ƒê√£ t·∫£i ƒë∆∞·ª£c log nh∆∞ng kh√¥ng th·ªÉ ƒë·ªçc to·∫° ƒë·ªô. Vui l√≤ng nh·∫•n F12 -> Console v√† ch·ª•p m√†n h√¨nh g·ª≠i cho dev.");
        }
    }

    // --- 4. MAP & REALTIME ---
    window.onload = function() {
        map = L.map('map').setView([10.762622, 106.660172], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        marker = L.marker([10.762622, 106.660172], { icon: createCarIcon() }).addTo(map);
        createInfoControl();
        
        setInterval(() => {
            if(LAT && LON && Math.abs(LAT)>0.1) marker.setLatLng([LAT, LON]);
        }, 1000);
    }

    function parseRealtime(raw) {
        // D√πng lu√¥n h√†m safeJsonParse cho realtime ƒë·ªÉ ƒë·ªìng b·ªô
        const d = safeJsonParse(raw);
        if (d) {
            if(d.lat) LAT=parseFloat(d.lat); if(d.lon) LON=parseFloat(d.lon);
            if(d.spd) SPEED=parseFloat(d.spd); if(d.alt) ALT=parseFloat(d.alt);
            if(d.temp) TEMP=parseFloat(d.temp); if(d.sat) SATS=parseInt(d.sat);
            updateInfoBox();
        }
    }

    function createCarIcon() {
        const svg = `<svg viewBox="0 0 1024 1024" width="48" height="48" xmlns="http://www.w3.org/2000/svg"><path d="${carPath}" fill="#1890ff" stroke="white" stroke-width="20"></path></svg>`;
        return L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin">${svg}</div>`, iconSize:[48,48], iconAnchor:[24,24] });
    }

    function createInfoControl() {
        infoControl = L.control({position: 'topright'});
        infoControl.onAdd = function() { this._div = L.DomUtil.create('div', 'info-box'); this.update(); return this._div; };
        infoControl.update = function() {
            const color = getGradientColor(SPEED);
            this._div.innerHTML = `
                <div class="info-title">REALTIME MONITOR</div>
                <div class="info-item"><span>Temp:</span><span class="info-value" style="color:#ff4d4f">${TEMP.toFixed(1)} ¬∞C</span></div>
                <div class="info-item"><span>Speed:</span><span class="info-value" style="color:${color}">${SPEED.toFixed(1)} km/h</span></div>
                <div class="info-item"><span>Alt:</span><span class="info-value">${ALT.toFixed(1)} m</span></div>
                <div class="info-item"><span>Sats:</span><span class="info-value">${SATS}</span></div>
            `;
        };
        infoControl.addTo(map);
    }
    function updateInfoBox() { if(infoControl) infoControl.update(); }

    function getGradientColor(speed) {
        const stops = [{s:0,c:[0,0,255]},{s:40,c:[0,255,0]},{s:70,c:[255,165,0]},{s:100,c:[255,0,0]},{s:120,c:[148,0,211]}];
        if (speed <= 0) return `rgb(${stops[0].c})`; if (speed >= 120) return `rgb(${stops[4].c})`;
        for (let i=0; i<stops.length-1; i++) {
            if (speed>=stops[i].s && speed<=stops[i+1].s) {
                let f=(speed-stops[i].s)/(stops[i+1].s-stops[i].s);
                let r=Math.round(stops[i].c[0]+f*(stops[i+1].c[0]-stops[i].c[0]));
                let g=Math.round(stops[i].c[1]+f*(stops[i+1].c[1]-stops[i].c[1]));
                let b=Math.round(stops[i].c[2]+f*(stops[i+1].c[2]-stops[i].c[2]));
                return `rgb(${r},${g},${b})`;
            }
        }
    }
</script>
</body>
</html>

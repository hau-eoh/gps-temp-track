<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker - Shortbread Default</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        /* --- T√ôY CH·ªàNH V·ªä TR√ç & ICON CONTROL (ƒêI·ªÇM M·ªöI) --- */

        /* Ch·ªânh l·∫°i style n√∫t ch·ªçn Layer cho ƒë·ªìng b·ªô v·ªõi n√∫t Zoom */
        .leaflet-control-layers {
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            box-shadow: none;
            margin-bottom: 5px !important;
            /* Kho·∫£ng c√°ch v·ªõi n√∫t Zoom */
        }

        /* Mobile: TƒÉng k√≠ch th∆∞·ªõc n√∫t b·∫•m m·ªôt ch√∫t cho d·ªÖ ·∫•n */
        @media (max-width: 768px) {

            .leaflet-touch .leaflet-control-layers,
            .leaflet-touch .leaflet-bar {
                border: 2px solid rgba(0, 0, 0, 0.2);
            }

            .leaflet-control-layers-toggle {
                width: 44px;
                height: 44px;
            }
        }

        /* --- UI STYLES C≈® (GI·ªÆ NGUY√äN) --- */
        .control-panel {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 13px;
            min-width: 160px;
            transition: all 0.3s ease;
        }

        .panel-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .control-label {
            font-weight: bold;
            color: #1890ff;
            font-size: 11px;
            text-transform: uppercase;
        }

        select,
        input[type="date"] {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }

        .loading-bar {
            height: 3px;
            width: 0%;
            background: #1890ff;
            transition: width 0.3s;
            margin-top: 5px;
            border-radius: 2px;
        }

        .control-panel.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .control-panel {
                display: none;
            }

            .control-panel.visible {
                display: flex;
            }

            .info-box {
                cursor: pointer;
                padding: 0;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: unset;
                overflow: hidden;
            }

            .info-box .info-content,
            .info-box .info-title {
                display: none;
            }

            .info-box::after {
                content: 'üìä';
                font-size: 18px;
            }

            .info-box.expanded {
                width: auto;
                height: auto;
                min-width: 180px;
                padding: 12px 15px;
                border-radius: 10px;
                display: block;
            }

            .info-box.expanded .info-title {
                display: block;
                margin-bottom: 8px;
                border-bottom: 2px solid #1890ff;
                text-align: center;
            }

            .info-box.expanded .info-content {
                display: block;
            }

            .info-box.expanded::after {
                display: none;
            }
        }

        .icon-menu-btn {
            position: absolute;
            bottom: 20px;
            left: 10px;
            z-index: 1000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-selection-panel {
            position: absolute;
            bottom: 70px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            gap: 8px;
            width: 150px;
        }

        .icon-selection-panel.visible {
            display: flex;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .icon-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .icon-option.active {
            background: #e6f7ff;
            font-weight: bold;
            color: #1890ff;
        }

        .icon-option svg {
            width: 24px;
            height: 24px;
            fill: #555;
        }

        .icon-option.active svg {
            fill: #1890ff;
        }

        .info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            min-width: 180px;
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .info-title {
            font-weight: 800;
            color: #333;
            margin-bottom: 8px;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 5px;
            text-align: center;
            font-size: 12px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
            color: #555;
        }

        .info-value {
            font-weight: bold;
            font-family: monospace;
            font-size: 14px;
            color: #222;
        }

        .custom-div-icon {
            background: transparent;
            border: none;
        }

        .marker-pin {
            filter: drop-shadow(0px 3px 6px rgba(0, 0, 0, 0.4));
        }
    </style>
</head>

<body>

    <button class="panel-toggle" onclick="toggleHistoryPanel()" title="C√†i ƒë·∫∑t / L·ªãch s·ª≠">‚öôÔ∏è</button>

    <div class="control-panel" id="historyPanel">
        <label class="control-label">‚ö° Xem nhanh</label>
        <select id="quickSelect" onchange="loadQuickHistory()">
            <option value="" disabled selected>-- Ch·ªçn --</option>
            <option value="1">1 Gi·ªù qua</option>
            <option value="6">6 Gi·ªù qua</option>
            <option value="12">12 Gi·ªù qua</option>
            <option value="24">24 Gi·ªù qua</option>
        </select>
        <div style="text-align:center; color:#ccc; font-size:10px; margin: 5px 0;">‚Äî HO·∫∂C ‚Äî</div>
        <label class="control-label">üìÖ Ch·ªçn ng√†y</label>
        <input type="date" id="datePicker" onchange="loadDateHistory()">
        <div class="loading-bar" id="loader"></div>
        <div id="statusText"
            style="font-size:10px; color:#666; text-align:center; margin-top:5px; border-top:1px solid #eee; padding-top:5px;">
            S·∫µn s√†ng</div>
    </div>

    <button class="icon-menu-btn" onclick="toggleIconPanel()" title="ƒê·ªïi bi·ªÉu t∆∞·ª£ng xe">üöò</button>
    <div class="icon-selection-panel" id="iconPanel">
        <div class="icon-option active" onclick="changeIcon('car', this)"><span class="preview-icon"></span> √î t√¥</div>
        <div class="icon-option" onclick="changeIcon('truck', this)"><span class="preview-icon"></span> Xe t·∫£i</div>
        <div class="icon-option" onclick="changeIcon('bike', this)"><span class="preview-icon"></span> Xe m√°y</div>
        <div class="icon-option" onclick="changeIcon('arrow', this)"><span class="preview-icon"></span> M≈©i t√™n</div>
    </div>

    <div id="map"></div>

    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>

    <script>
        const eraWidget = new EraWidget();
        let configJSON;
        let LAT = 0, LON = 0, SPEED = 0, ALT = 0, TEMP = 0, SATS = 0, BAT_VOLT = 0;

        let map, marker, infoControl;
        let historyPolyline = null;
        let historyLayerGroup = null;

        // --- 1. ƒê·ªäNH NGHƒ®A ICONS & VIEWBOX ---
        const ICONS = {
            car: "M10.17,34.23c-10.98-5.58-9.72-11.8,1.31-11.15l2.47,4.63l5.09-15.83C21.04,5.65,24.37,0,30.9,0H96 c6.53,0,10.29,5.54,11.87,11.87l3.82,15.35l2.2-4.14c11.34-0.66,12.35,5.93,0.35,11.62l1.95,2.99c7.89,8.11,7.15,22.45,5.92,42.48 v8.14c0,2.04-1.67,3.71-3.71,3.71h-15.83c-2.04,0-3.71-1.67-3.71-3.71v-4.54H24.04v4.54c0,2.04-1.67,3.71-3.71,3.71H4.5 c-2.04,0-3.71-1.67-3.71-3.71V78.2c0-0.2,0.02-0.39,0.04-0.58C-0.37,62.25-2.06,42.15,10.17,34.23L10.17,34.23z M30.38,58.7 l-14.06-1.77c-3.32-0.37-4.21,1.03-3.08,3.89l1.52,3.69c0.49,0.95,1.14,1.64,1.9,2.12c0.89,0.55,1.96,0.82,3.15,0.87l12.54,0.1 c3.03-0.01,4.34-1.22,3.39-4C34.96,60.99,33.18,59.35,30.38,58.7L30.38,58.7z M54.38,52.79h14.4c0.85,0,1.55,0.7,1.55,1.55l0,0 c0,0.85-0.7,1.55-1.55,1.55h-14.4c-0.85,0-1.55-0.7-1.55-1.55l0,0C52.82,53.49,53.52,52.79,54.38,52.79L54.38,52.79z M89.96,73.15 h14.4c0.85,0,1.55,0.7,1.55,1.55l0,0c0,0.85-0.7,1.55-1.55,1.55h-14.4c-0.85,0-1.55-0.7-1.55-1.55l0,0 C88.41,73.85,89.1,73.15,89.96,73.15L89.96,73.15z M92.5,58.7l14.06-1.77c3.32-0.37,4.21,1.03,3.08,3.89l-1.52,3.69 c-0.49,0.95-1.14,1.64-1.9,2.12c-0.89,0.55-1.96,0.82-3.15,0.87l-12.54,0.1c-3.03-0.01-4.34-1.22-3.39-4 C87.92,60.99,89.7,59.35,92.5,58.7L92.5,58.7z M18.41,73.15h14.4c0.85,0,1.55,0.7,1.55,1.55l0,0c0,0.85-0.7,1.55-1.55,1.55h-14.4 c-0.85,0-1.55-0.7-1.55-1.55l0,0C16.86,73.85,17.56,73.15,18.41,73.15L18.41,73.15z M19.23,31.2h86.82l-3.83-15.92 c-1.05-4.85-4.07-9.05-9.05-9.05H33.06c-4.97,0-7.52,4.31-9.05,9.05L19.23,31.2v0.75V31.2L19.23,31.2z",
            truck: "M41.63,58.19a12.9,12.9,0,1,0,25.64,2,13.7,13.7,0,0,0-.16-2H89.28a14.22,14.22,0,0,0-.12,1.87,13.08,13.08,0,0,0,26.16,0,12.7,12.7,0,0,0-.21-2.33,8,8,0,0,0,7.77-7.93V24.14L106.61,6.64H84.32V45.51h-80A3.27,3.27,0,0,0,1,48.68V55A3.27,3.27,0,0,0,4.31,58.2H7.94a12.48,12.48,0,0,0-.16,2,12.9,12.9,0,1,0,25.79,0,13.7,13.7,0,0,0-.16-2h8.22ZM76.48,0H4.1A4.12,4.12,0,0,0,0,4.1V42.27H80.58V4.1A4.11,4.11,0,0,0,76.48,0ZM15.71,60.26c0,6.53,9.92,6.53,9.92,0,0-7-9.92-6.27-9.92,0Zm81.49-.21c0,6.61,10.06,6.61,10.06,0s-10.06-6.65-10.06,0Zm9.33-45.85L114.74,24v3.56H92.49V14.2ZM49.42,60.26c0,6.53,9.92,6.53,9.92,0s-9.92-6.52-9.92,0Z",
            bike: "M77.1.61h40.36a2.48,2.48,0,0,1,2.47,2.47V30.52h.24a2.72,2.72,0,0,1,2.71,2.72v3A2.77,2.77,0,0,1,120.12,39H101.05c14.17,1.26,22.27,14.44,21.39,31.58H109.83a15,15,0,0,1-29.95,0h-38c0-.27,0-.54,0-.8a40.85,40.85,0,0,1-.34,5.8l-7.91-3.73A15.29,15.29,0,1,1,7.61,59.63L0,56c6.34-7.21,14-10.24,23.25-8.16,3.31.84,6.41,1.59-.08,0A112.39,112.39,0,0,1,33.72,13.07L29,13h0c-1,0-2.05.25-2.72-.24a3.59,3.59,0,0,1-2.88-1.84,7.12,7.12,0,0,1-1-3.79,7.16,7.16,0,0,1,1-3.8,3.91,3.91,0,0,1,2-1.68,1,1,0,0,1,0-.3C26.51-.46,28.7.08,30.65.08l1.9.12a11.1,11.1,0,0,1,4,1.36l2.17,1.22h1.76L46.4,3.92c1.93.38,2.21.22,1.76,2.59a7.49,7.49,0,0,1-.24.9c-.58,1.73-1,1.09-2.84.72L39.55,7c.21,2.23-.5,5-1.49,8.15,3.17,2.69,4.61,6.52,2.43,11.58L35.21,43c8.86,6.28,14.18,12,14.49,21.29H60.93c7.22-5.47,6-15.21-1.9-21.43V39h0V33.16c0-1.86,1-2.7,2.85-2.64H74.63V3.08A2.48,2.48,0,0,1,77.1.61ZM24.36,67.53,16.81,64a6.72,6.72,0,1,0,7.55,3.56Zm1.1-64.26c.09,2.53.25,5.78.37,8a3.4,3.4,0,0,1-.61-.72,6.54,6.54,0,0,1-.89-3.46,6.5,6.5,0,0,1,.89-3.45c.08-.12.16-.24.24-.34ZM98.22,4.86a2.27,2.27,0,0,1,1.6.67,2.32,2.32,0,0,1,.35,2.8,13.12,13.12,0,0,1,3.41,1c5,2.5,7.74,6.41,7.74,12.22a.67.67,0,0,1-.62.67H85.77a.66.66,0,0,1-.66-.67A12.88,12.88,0,0,1,92.85,9.34a12.64,12.64,0,0,1,3.41-1,2.31,2.31,0,0,1,.35-2.8,2.28,2.28,0,0,1,1.61-.67ZM82.36,26.09V24.22a.19.19,0,0,1,.19-.2h31.24a.19.19,0,0,1,.19.2v1.87a.19.19,0,0,1-.19.19H82.55a.19.19,0,0,1-.19-.19ZM101.45,70.6a6.6,6.6,0,0,1-13.19,0Z",
            arrow: "M43.46,25.59c9.31,0,16.86,7.55,16.86,16.86s-7.55,16.86-16.86,16.86c-9.31,0-16.86-7.55-16.86-16.86 S34.15,25.59,43.46,25.59L43.46,25.59z"
        };

        const VIEWBOXES = {
            car: "0 0 122.88 92.02",
            truck: "0 0 122.92 82.2",
            bike: "0 0 122.89 74.13",
            arrow: "0 0 86.92 86.92" // Arrow th∆∞·ªùng l√† h√¨nh vu√¥ng
        };

        let currentIconType = 'car';

        // --- 2. INIT E-RA ---
        eraWidget.init({
            onConfiguration: (configs) => {
                configJSON = configs.realtime_configs[0];
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('datePicker').value = today;
                loadQuickHistory(1);
            },
            onValues: (values) => {
                if (configJSON && values[configJSON.id]) parseRealtime(values[configJSON.id].value);
            },
            onHistories: (history) => {
                setLoading(false);
                if (history && history[0] && history[0].data) {
                    processHistory(history[0].data);
                } else {
                    document.getElementById('statusText').innerText = "Kh√¥ng c√≥ d·ªØ li·ªáu log";
                    clearMapHistory();
                }
            }
        });

        // --- 3. WINDOW LOAD & SETUP MAP ---
        window.onload = function () {
            // --- LAYERS SETUP ---
            const shortbreadLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 20, attribution: '¬© CARTO' });
            const transportLayer = L.tileLayer('https://tile.memomaps.de/tilegen/{z}/{x}/{y}.png', { maxZoom: 18, attribution: 'memomaps.de' });
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' });
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles ¬© Esri' });

            // Init Map
            map = L.map('map', {
                zoomControl: false,
                layers: [shortbreadLayer] // M·∫∑c ƒë·ªãnh: G·ªçn g√†ng
            }).setView([10.762622, 106.660172], 15);

            // Add Controls (Bottom Right Stacked)
            const baseMaps = {
                "G·ªçn g√†ng (Shortbread)": shortbreadLayer,
                "Giao th√¥ng (Transport)": transportLayer,
                "M·∫∑c ƒë·ªãnh (Standard)": osmLayer,
                "V·ªá tinh (Satellite)": satelliteLayer
            };
            L.control.layers(baseMaps, null, { position: 'bottomright' }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Add Marker
            marker = L.marker([10.762622, 106.660172], { icon: createCarIcon() }).addTo(map);

            createInfoControl();
            initIconMenu();

            // Loop update marker
            setInterval(() => { if (LAT && LON && Math.abs(LAT) > 0.1) marker.setLatLng([LAT, LON]); }, 1000);

            eraWidget.mobileHeight(600);
            eraWidget.ready();
        }

        // --- 4. ICON HELPER FUNCTIONS ---
        function getViewBox(type) {
            return VIEWBOXES[type] || "0 0 100 100";
        }

        function createCarIcon() {
            const type = currentIconType;
            const path = ICONS[type] || ICONS.car;
            const viewBox = getViewBox(type);

            // Th√™m fill-rule="evenodd" ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng l·ªó h·ªïng trong icon
            const svg = `<svg viewBox="${viewBox}" width="48" height="48" xmlns="http://www.w3.org/2000/svg"><path d="${path}" fill="#1890ff" stroke="white" stroke-width="2" fill-rule="evenodd"></path></svg>`;

            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin">${svg}</div>`,
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });
        }

        function initIconMenu() {
            document.querySelectorAll('.icon-option').forEach(el => {
                const onclickText = el.getAttribute('onclick');
                if (!onclickText) return;
                const match = onclickText.match(/'([^']+)'/);
                if (!match) return;

                const type = match[1];
                const path = ICONS[type];
                const viewBox = getViewBox(type);

                if (path) {
                    el.querySelector('.preview-icon').innerHTML = `<svg viewBox="${viewBox}" width="24" height="24"><path d="${path}" fill="#555" fill-rule="evenodd"></path></svg>`;
                }
            });
        }

        function changeIcon(type, element) {
            currentIconType = type;
            document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('active'));
            if (element) element.classList.add('active');
            if (marker) { marker.setIcon(createCarIcon()); }
            toggleIconPanel();
        }

        function toggleIconPanel() { document.getElementById('iconPanel').classList.toggle('visible'); }

        // --- 5. DATA & MAP LOGIC (GI·ªÆ NGUY√äN) ---
        function loadQuickHistory(hoursOverride) {
            let hours = hoursOverride || document.getElementById('quickSelect').value;
            if (!hours) return;
            setLoading(true);
            const endTime = Date.now();
            const startTime = endTime - (hours * 60 * 60 * 1000);
            requestData(startTime, endTime);
        }

        function loadDateHistory() {
            const dateVal = document.getElementById('datePicker').value;
            if (!dateVal) return;
            document.getElementById('quickSelect').value = "";
            setLoading(true);
            const start = new Date(dateVal + "T00:00:00");
            const end = new Date(dateVal + "T23:59:59");
            requestData(start.getTime(), end.getTime());
        }

        function requestData(start, end) {
            clearMapHistory();
            eraWidget.requestHistories(start, end);
        }

        function clearMapHistory() {
            if (historyPolyline) { map.removeLayer(historyPolyline); historyPolyline = null; }
            if (historyLayerGroup) { historyLayerGroup.clearLayers(); }
        }

        function setLoading(isLoading) {
            document.getElementById('loader').style.width = isLoading ? '100%' : '0%';
            if (isLoading) document.getElementById('statusText').innerText = "ƒêang t·∫£i...";
        }

        function safeJsonParse(input) {
            if (!input) return null;
            if (typeof input === 'object') return input;
            if (typeof input === 'string') {
                const trimmed = input.trim();
                try {
                    const parsed = JSON.parse(trimmed);
                    if (typeof parsed === 'string') return safeJsonParse(parsed);
                    return parsed;
                } catch (e) { return null; }
            }
            return null;
        }

        function processHistory(dataArray) {
            const latLngs = [];
            const cleanData = [];
            let skippedCount = 0;
            let validCount = 0;

            dataArray.forEach((item) => {
                try {
                    let raw = null;
                    let ts = null;
                    if (item.y !== undefined) { raw = item.y; ts = item.x; }
                    else if (Array.isArray(item) && item.length >= 2) { raw = item[1]; ts = item[0]; }

                    let d = safeJsonParse(raw);
                    if (d && d.lat !== undefined && d.lon !== undefined) {
                        const lat = parseFloat(d.lat);
                        const lon = parseFloat(d.lon);
                        if (!isNaN(lat) && !isNaN(lon) && Math.abs(lat) > 0.0001 && Math.abs(lon) > 0.0001) {
                            latLngs.push([lat, lon]);
                            cleanData.push({
                                lat: lat, lon: lon,
                                temp: parseFloat(d.temp || 0),
                                spd: parseFloat(d.spd || 0),
                                alt: parseFloat(d.alt || 0),
                                ts: ts
                            });
                            validCount++;
                        } else { skippedCount++; }
                    } else { skippedCount++; }
                } catch (e) { skippedCount++; }
            });

            if (validCount > 0) {
                document.getElementById('statusText').innerText = `Hi·ªÉn th·ªã ${validCount} ƒëi·ªÉm\n(B·ªè qua ${skippedCount} l·ªói)`;
                historyPolyline = L.polyline(latLngs, { color: '#999', weight: 3, opacity: 0.5, dashArray: '5, 5' }).addTo(map);
                historyLayerGroup = L.layerGroup().addTo(map);

                cleanData.forEach(pt => {
                    const color = getGradientColor(pt.spd);
                    const circle = L.circleMarker([pt.lat, pt.lon], { radius: 5, fillColor: color, color: '#fff', weight: 1, opacity: 1, fillOpacity: 1 });
                    const dateObj = new Date(pt.ts);
                    const timeStr = !isNaN(dateObj.getTime()) ? dateObj.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : "N/A";
                    const popupContent = `<div style="text-align:center"><div style="font-size:10px; color:#888">${timeStr}</div><div style="font-size:18px; font-weight:bold; color:${color}">${pt.spd.toFixed(0)} km/h</div><div style="font-size:12px; margin-top:2px;">Temp: <b style="color:#ff4d4f">${pt.temp}¬∞C</b></div></div>`;
                    circle.bindPopup(popupContent, { closeButton: false });
                    circle.addTo(historyLayerGroup);
                });
                map.fitBounds(historyPolyline.getBounds(), { padding: [50, 50] });
                L.marker(latLngs[0], { title: 'B·∫Øt ƒë·∫ßu' }).addTo(historyLayerGroup).bindPopup("<b>B·∫Øt ƒë·∫ßu</b>");
                L.marker(latLngs[latLngs.length - 1], { title: 'K·∫øt th√∫c' }).addTo(historyLayerGroup).bindPopup("<b>K·∫øt th√∫c</b>");
            } else {
                document.getElementById('statusText').innerText = skippedCount > 0 ? "D·ªØ li·ªáu to√†n 0,0 ho·∫∑c l·ªói format" : "Kh√¥ng c√≥ d·ªØ li·ªáu";
            }
        }

        function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            if (window.innerWidth <= 768) { panel.classList.toggle('visible'); }
            else { panel.classList.toggle('hidden'); }
        }

        function parseRealtime(raw) {
            const d = safeJsonParse(raw);
            if (d) {
                if (d.lat) LAT = parseFloat(d.lat); if (d.lon) LON = parseFloat(d.lon);
                if (d.spd) SPEED = parseFloat(d.spd); if (d.alt) ALT = parseFloat(d.alt);
                if (d.temp) TEMP = parseFloat(d.temp); if (d.sat) SATS = parseInt(d.sat);
                if (d.bat) BAT_VOLT = parseFloat(d.bat);
                updateInfoBox();
            }
        }

        function createInfoControl() {
            infoControl = L.control({ position: 'topright' });
            infoControl.onAdd = function () {
                this._div = L.DomUtil.create('div', 'info-box');
                this._div.onclick = function (e) { if (window.innerWidth <= 768) { this.classList.toggle('expanded'); } };
                this.update(); return this._div;
            };
            infoControl.update = function () {
                const color = getGradientColor(SPEED);
                const batIcon = getBatteryIcon(BAT_VOLT);
                this._div.innerHTML = `<div class="info-title">REALTIME MONITOR ${batIcon} <span class="info-toggle-icon"></span></div><div class="info-content"><div class="info-item"><span>Temp:</span><span class="info-value" style="color:#ff4d4f">${TEMP.toFixed(1)} ¬∞C</span></div><div class="info-item"><span>Speed:</span><span class="info-value" style="color:${color}">${SPEED.toFixed(1)} km/h</span></div><div class="info-item"><span>Alt:</span><span class="info-value">${ALT.toFixed(1)} m</span></div><div class="info-item"><span>Sats:</span><span class="info-value">${SATS}</span></div><div class="info-item"><span>Bat:</span><span class="info-value">${BAT_VOLT.toFixed(2)} V</span></div></div>`;
            };
            infoControl.addTo(map);
        }
        function updateInfoBox() { if (infoControl) infoControl.update(); }

        function getBatteryIcon(volt) {
            let color = '#52c41a'; let fillWidth = 20;
            if (volt >= 4.0) { fillWidth = 20; color = '#52c41a'; }
            else if (volt >= 3.8) { fillWidth = 15; color = '#52c41a'; }
            else if (volt >= 3.6) { fillWidth = 10; color = '#faad14'; }
            else { fillWidth = 5; color = '#ff4d4f'; }
            return `<svg width="24" height="14" viewBox="0 0 24 14" style="vertical-align: middle; margin-left: 5px;"><rect x="1" y="1" width="20" height="12" rx="1" ry="1" stroke="#555" stroke-width="1" fill="none"></rect><rect x="22" y="4" width="2" height="6" rx="1" ry="1" fill="#555"></rect><rect x="3" y="3" width="${fillWidth}" height="8" rx="0.5" ry="0.5" fill="${color}"></rect></svg>`;
        }

        function getGradientColor(speed) {
            const stops = [{ s: 0, c: [0, 0, 255] }, { s: 40, c: [0, 255, 0] }, { s: 70, c: [255, 165, 0] }, { s: 100, c: [255, 0, 0] }, { s: 120, c: [148, 0, 211] }];
            if (speed <= 0) return `rgb(${stops[0].c})`; if (speed >= 120) return `rgb(${stops[4].c})`;
            for (let i = 0; i < stops.length - 1; i++) {
                if (speed >= stops[i].s && speed <= stops[i + 1].s) {
                    let f = (speed - stops[i].s) / (stops[i + 1].s - stops[i].s);
                    let r = Math.round(stops[i].c[0] + f * (stops[i + 1].c[0] - stops[i].c[0]));
                    let g = Math.round(stops[i].c[1] + f * (stops[i + 1].c[1] - stops[i].c[1]));
                    let b = Math.round(stops[i].c[2] + f * (stops[i + 1].c[2] - stops[i].c[2]));
                    return `rgb(${r},${g},${b})`;
                }
            }
        }
    </script>
</body>

</html>

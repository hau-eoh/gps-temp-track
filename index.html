<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS History - Date Picker</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; }

        /* --- CONTROL PANEL (MENU) --- */
        .control-panel {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: white; padding: 10px 15px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column; gap: 8px;
            font-size: 13px; min-width: 160px;
        }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-label { font-weight: bold; color: #1890ff; font-size: 11px; text-transform: uppercase; }
        
        /* Select & Input Style */
        select, input[type="date"] {
            padding: 6px; border-radius: 4px; border: 1px solid #ccc; 
            font-family: inherit; font-size: 13px; width: 100%; box-sizing: border-box;
        }
        select:focus, input:focus { outline: none; border-color: #1890ff; }

        .loading-bar {
            height: 3px; width: 0%; background: #1890ff; transition: width 0.3s;
            margin-top: 5px; border-radius: 2px;
        }

        /* --- INFO BOX --- */
        .info-box {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            padding: 12px 15px; background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); border-radius: 10px;
            min-width: 180px; border: 1px solid #f0f0f0;
        }
        .info-title { font-weight: 800; color: #333; margin-bottom: 8px; border-bottom: 2px solid #1890ff; padding-bottom: 5px; text-align: center; text-transform: uppercase; font-size: 12px; }
        .info-item { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; color: #555; }
        .info-value { font-weight: bold; font-family: monospace; font-size: 14px; color: #222; }
        
        /* Popup Style */
        .history-popup .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; }
        .history-popup .leaflet-popup-content { margin: 10px; text-align: center; }
        .popup-temp { font-size: 24px; font-weight: bold; color: #ff4d4f; line-height: 1.2; }
        .popup-sub { font-size: 12px; color: #666; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }

        .custom-div-icon { background: transparent; border: none; }
        .marker-pin { filter: drop-shadow(0px 3px 6px rgba(0,0,0,0.4)); }
    </style>
</head>
<body>

<div class="control-panel">
    <div class="control-group">
        <label class="control-label">‚ö° Xem nhanh</label>
        <select id="quickSelect" onchange="loadQuickHistory()">
            <option value="" disabled selected>-- Ch·ªçn --</option>
            <option value="1">1 Gi·ªù qua</option>
            <option value="6">6 Gi·ªù qua</option>
            <option value="12">12 Gi·ªù qua</option>
            <option value="24">24 Gi·ªù qua</option>
        </select>
    </div>

    <div style="text-align:center; color:#ccc; font-size:10px;">‚Äî HO·∫∂C ‚Äî</div>

    <div class="control-group">
        <label class="control-label">üìÖ Ch·ªçn ng√†y</label>
        <input type="date" id="datePicker" onchange="loadDateHistory()">
    </div>

    <div class="loading-bar" id="loader"></div>
    <div id="statusText" style="font-size:10px; color:#666; text-align:center; margin-top:2px;">S·∫µn s√†ng</div>
</div>

<div id="map"></div>

<script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>

<script>
    const eraWidget = new EraWidget();
    let configJSON;
    
    let LAT=0, LON=0, SPEED=0, ALT=0, TEMP=0, SATS=0;
    
    let map, marker, infoControl;
    let historyPolyline = null;
    let historyDataPoints = []; 

    const carPath = "M880 348H730l-10.4-38.6c-4.9-18.1-21.5-30.7-40.2-30.7H344.6c-18.7 0-35.3 12.5-40.2 30.7L294 348H144c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V380c0-17.7-14.3-32-32-32zM363.6 348l13-48h270.8l13 48H363.6zM848 732H176V412h672v320zM304 528c0-35.3 28.7-64 64-64s64 28.7 64 64-28.7 64-64 64-64-28.7-64-64z m352 0c0-35.3 28.7-64 64-64s64 28.7 64 64-28.7 64-64 64-64-28.7-64-64z";

    // --- 1. INIT ---
    eraWidget.init({
        onConfiguration: (configs) => {
            configJSON = configs.realtime_configs[0];
            
            // Set m·∫∑c ƒë·ªãnh ng√†y h√¥m nay cho DatePicker
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
            
            // Load m·∫∑c ƒë·ªãnh 24h qua
            loadQuickHistory(24);
        },
        onValues: (values) => {
            if (configJSON && values[configJSON.id]) parseRealtime(values[configJSON.id].value);
        },
        onHistories: (history) => {
            setLoading(false);
            if (history && history[0] && history[0].data) {
                const count = history[0].data.length;
                document.getElementById('statusText').innerText = `T√¨m th·∫•y ${count} ƒëi·ªÉm`;
                processHistory(history[0].data);
            } else {
                document.getElementById('statusText').innerText = "Kh√¥ng c√≥ d·ªØ li·ªáu";
                clearMapHistory();
            }
        }
    });

    // --- 2. X·ª¨ L√ù L·ªäCH S·ª¨ (CORE LOGIC) ---

    // Option A: Load theo gi·ªù (Quick)
    function loadQuickHistory(hoursOverride) {
        let hours = hoursOverride || document.getElementById('quickSelect').value;
        if (!hours) return;

        // Reset DatePicker ƒë·ªÉ user kh√¥ng nh·∫ßm l·∫´n
        // document.getElementById('datePicker').value = ''; 
        
        setLoading(true);
        const endTime = Date.now();
        const startTime = endTime - (hours * 60 * 60 * 1000);
        
        requestData(startTime, endTime);
    }

    // Option B: Load theo ng√†y c·ª• th·ªÉ (Date Picker)
    function loadDateHistory() {
        const dateVal = document.getElementById('datePicker').value;
        if (!dateVal) return;

        // Reset Quick Select
        document.getElementById('quickSelect').value = ""; 

        setLoading(true);

        // T·∫°o th·ªùi gian b·∫Øt ƒë·∫ßu (00:00:00) v√† k·∫øt th√∫c (23:59:59) c·ªßa ng√†y ƒë∆∞·ª£c ch·ªçn
        // L∆∞u √Ω: dateVal c√≥ d·∫°ng YYYY-MM-DD
        const start = new Date(dateVal + "T00:00:00");
        const end = new Date(dateVal + "T23:59:59");
        
        requestData(start.getTime(), end.getTime());
    }

    function requestData(start, end) {
        clearMapHistory();
        eraWidget.requestHistories(start, end);
    }

    function clearMapHistory() {
        if (historyPolyline) {
            map.removeLayer(historyPolyline);
            historyPolyline = null;
        }
        historyDataPoints = [];
    }

    function setLoading(isLoading) {
        const loader = document.getElementById('loader');
        const status = document.getElementById('statusText');
        if (isLoading) {
            loader.style.width = '100%';
            status.innerText = "ƒêang t·∫£i...";
        } else {
            loader.style.width = '0%';
        }
    }

    // --- 3. V·∫º MAP ---
    function processHistory(dataArray) {
        const latLngs = [];
        const cleanData = [];

        dataArray.forEach(item => {
            try {
                const raw = item[1];
                if (typeof raw === 'string' && raw.startsWith('{')) {
                    const d = JSON.parse(raw);
                    if (d.lat && d.lon && Math.abs(d.lat) > 0.1) {
                        const lat = parseFloat(d.lat);
                        const lon = parseFloat(d.lon);
                        latLngs.push([lat, lon]);
                        cleanData.push({
                            lat: lat, lon: lon,
                            temp: parseFloat(d.temp || 0),
                            spd: parseFloat(d.spd || 0),
                            alt: parseFloat(d.alt || 0),
                            ts: item[0]
                        });
                    }
                }
            } catch (e) {}
        });

        historyDataPoints = cleanData;

        if (latLngs.length > 0) {
            historyPolyline = L.polyline(latLngs, {
                color: '#3388ff', weight: 5, opacity: 0.8, lineJoin: 'round'
            }).addTo(map);

            map.fitBounds(historyPolyline.getBounds());

            historyPolyline.on('click', function(e) {
                const closestPoint = findClosestDataPoint(e.latlng);
                if (closestPoint) showHistoryPopup(closestPoint);
            });
        }
    }

    function findClosestDataPoint(clickLatLng) {
        let minDist = Infinity;
        let closest = null;
        historyDataPoints.forEach(pt => {
            const dLat = pt.lat - clickLatLng.lat;
            const dLon = pt.lon - clickLatLng.lng;
            const distSq = dLat*dLat + dLon*dLon;
            if (distSq < minDist) { minDist = distSq; closest = pt; }
        });
        return closest;
    }

    function showHistoryPopup(pt) {
        const timeStr = new Date(pt.ts).toLocaleTimeString('vi-VN');
        const popupContent = `
            <div class="popup-temp">${pt.temp.toFixed(1)}¬∞C</div>
            <div class="popup-sub">
                <b>${pt.spd.toFixed(1)} km/h</b> | Alt: ${pt.alt}m<br>
                <span style="color:#999; font-size:10px">${timeStr}</span>
            </div>
        `;
        L.popup({ className: 'history-popup', offset: [0, -5] })
        .setLatLng([pt.lat, pt.lon])
        .setContent(popupContent)
        .openOn(map);
    }

    // --- 4. MAP & REALTIME ---
    window.onload = function() {
        map = L.map('map').setView([10.762622, 106.660172], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        marker = L.marker([10.762622, 106.660172], { icon: createCarIcon() }).addTo(map);
        createInfoControl();
        setInterval(() => { if(LAT && LON) marker.setLatLng([LAT, LON]); }, 1000);
    }

    function parseRealtime(raw) {
        try {
            const d = JSON.parse(raw);
            if(d.lat) LAT=parseFloat(d.lat); if(d.lon) LON=parseFloat(d.lon);
            if(d.spd) SPEED=parseFloat(d.spd); if(d.alt) ALT=parseFloat(d.alt);
            if(d.temp) TEMP=parseFloat(d.temp); if(d.sat) SATS=parseInt(d.sat);
            updateInfoBox();
        } catch(e){}
    }

    function createCarIcon() {
        const svg = `<svg viewBox="0 0 1024 1024" width="48" height="48" xmlns="http://www.w3.org/2000/svg"><path d="${carPath}" fill="#1890ff" stroke="white" stroke-width="20"></path></svg>`;
        return L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin">${svg}</div>`, iconSize:[48,48], iconAnchor:[24,24] });
    }

    function createInfoControl() {
        infoControl = L.control({position: 'topright'});
        infoControl.onAdd = function() { this._div = L.DomUtil.create('div', 'info-box'); this.update(); return this._div; };
        infoControl.update = function() {
            this._div.innerHTML = `
                <div class="info-title">REALTIME MONITOR</div>
                <div class="info-item"><span>Temp:</span><span class="info-value" style="color:#ff4d4f">${TEMP.toFixed(1)} ¬∞C</span></div>
                <div class="info-item"><span>Speed:</span><span class="info-value">${SPEED.toFixed(1)} km/h</span></div>
                <div class="info-item"><span>Alt:</span><span class="info-value">${ALT.toFixed(1)} m</span></div>
                <div class="info-item"><span>Sats:</span><span class="info-value">${SATS}</span></div>
            `;
        };
        infoControl.addTo(map);
    }
    function updateInfoBox() { if(infoControl) infoControl.update(); }

</script>
</body>
</html>
